<!--
 * @Author: kevincnzhengyang kevin.cn.zhengyang@gmail.com
 * @Date: 2025-09-07 10:39:49
 * @LastEditors: kevincnzhengyang kevin.cn.zhengyang@gmail.com
 * @LastEditTime: 2025-09-07 10:41:42
 * @FilePath: /miaosuan/dashboard/templates/task_detail.html
 * @Description: 
 * 
 * Copyright (c) 2025 by ${git_name_email}, All Rights Reserved. 
-->
{% extends "base.html" %}
{% block title %}任务 {{ task_id }}{% endblock %}
{% block content %}
<h1 class="text-2xl mb-4">任务 {{ task_id }} 详情</h1>

<div class="mb-4">
    <h2 class="text-xl">回测指标</h2>
    <ul>
    {% for k,v in metrics.items() %}
        <li>{{ k }}: {{ v }}</li>
    {% endfor %}
    </ul>
</div>

<div id="plot" style="height:500px;"></div>

<script>
const window_id = crypto.randomUUID();
const task_id = "{{ task_id }}";
let ws = new WebSocket(`ws://${location.host}/ws/${window_id}/${task_id}`);

let x=[], y=[], buy_x=[], buy_y=[], sell_x=[], sell_y=[];
ws.onmessage = function(event){
    let data = JSON.parse(event.data);
    x = data.equity.map(d=>d.datetime);
    y = data.equity.map(d=>d.equity);
    buy_x = data.signals.filter(s=>s.signal==1).map(s=>s.datetime);
    buy_y = data.signals.filter(s=>s.signal==1).map(s=>s.price);
    sell_x = data.signals.filter(s=>s.signal==-1).map(s=>s.datetime);
    sell_y = data.signals.filter(s=>s.signal==-1).map(s=>s.price);

    Plotly.newPlot('plot', [
        {x:x, y:y, mode:'lines', name:'Equity'},
        {x:buy_x, y:buy_y, mode:'markers', marker:{symbol:'triangle-up', color:'green', size:10}, name:'Buy'},
        {x:sell_x, y:sell_y, mode:'markers', marker:{symbol:'triangle-down', color:'red', size:10}, name:'Sell'}
    ]);
}

// 时间同步
setInterval(()=>{
    const last_time = x && x[x.length-1] ? x[x.length-1] : null;
    if(last_time) ws.send(JSON.stringify({last_time: last_time}));
}, 1000);

window.addEventListener("beforeunload", ()=>{
    ws.close();
});
</script>
{% endblock %}
